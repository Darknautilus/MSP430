\documentclass[a4paper,11pt,article]{memoir}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fonts
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[francais]{babel}
\usepackage{microtype}
\usepackage{lmodern}

\usepackage[scaled=0.95]{helvet}
\renewcommand\familydefault{\sfdefault}
\usepackage[EULERGREEK]{sansmath}\sansmath % sans-serif math w/ greeks

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Page layout

\usepackage[margin=2cm]{geometry}
\pagestyle{plain}
\setlength{\parindent}{0pt}

\renewcommand*{\chaptitlefont}{\secheadstyle}% for toc, bib, and friends 
\setsecheadstyle{\Large} % default: \Large\bfseries
\setsubsecheadstyle{\large} % default: \Large\bfseries
\setsecnumdepth{subsubsection}
\settocdepth{subsubsection}
\renewcommand*{\thesection}{\arabic{section}}
\renewcommand*{\thesubsection}{\thesection.\arabic{subsection}}
\setbeforesecskip{3 ex plus 1ex minus 1ex} % default(ex): 3.5+1-.2
\setaftersecskip{2 ex plus 1ex minus 1ex} % default(ex): 2.3+.2
\setbeforeparaskip{2 ex plus 1ex minus 1ex}% default(ex): 3.25+1-.2

\setcounter{secnumdepth}{3}

\renewcommand\title[1]{{\LARGE\fontfamily{pag}\selectfont #1}\par\bigskip}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Utilities


% \usepackage{minted} % syntax coloring % If you don't have the
% 'minted' package, just turn all listings to verbatim :-)

\usepackage{boxedminipage}

\newenvironment{reponse}{
\begin{center}
  \begin{boxedminipage}{0.9\linewidth}\underline{R√©ponse}~:~
}{
  \end{boxedminipage}
\end{center}
}

\usepackage{graphicx}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document body

\begin{document}

\includegraphics[height=2cm]{fig/insa.pdf}
%
\hfill
%
{\fontfamily{pag}\selectfont D√©partement IF / Architecture Mat√©rielle}

\bigskip

\title{TP2: D√©veloppement Crois√©}

\bigskip
\noindent\par\parbox{.48\textwidth}{Nom : Bertron} \parbox{.48\textwidth}{Pr√©nom : Aur√©lien}
\bigskip
\noindent\par\parbox{.48\textwidth}{Nom : Losbar} \parbox{.48\textwidth}{Pr√©nom : Thomas}
\bigskip
\noindent\par\parbox{.2\textwidth}{Groupe : 2} \parbox{.2\textwidth}{Bin√¥me : B3229}

\bigskip

\paragraph{Question 1 ---}  La fonction \verb|lcd_init()| √©crit dans les registres LCDACTL, LCDAPCTL (0 et 1) et LCDMEM (1 √† 20).

\paragraph{Question 2 ---}  

\paragraph{Question 3 ---}  D'apr√®s MSP430.pdf[750], tous les registres font 8 bits. D'apr√®s datasheet.pdf[16], les registres 8 bits de p√©riph√©riques sont situ√©s entre les adresses 0FFh et 010h.

\paragraph{Question 4 ---}  Les plages d'adresses sont sp√©cifi√©es √† la m√™me adresse :
%\begin{figure}
\includegraphics[height=6cm]{fig/plagesAdressage.png}
%\end{figure}

\paragraph{Question 5 ---}  Dans Compiler.pdf[207], on peut voir qu'en C, l'op√©rateur @ permet de d√©finir l'adresse √† laquelle est stock√©e une variable. Ces deux lignes sont des d√©clarations de macros qui permettent de d√©finir une variable √† une adresse donn√©e. La seule diff√©rence est la taille de la zone m√©moire : 16 bits pour DEFW, 8 bits pour DEFC.

\paragraph{Question 6 ---}  Trouv√© dans MSP430.pdf[750/736] : on voit que \(f_{LCD} = 2 \times mux \times f_{frame}\), on cherche $f_{frame}$. On indique dans le code que l'on divise ACLK par 512 (bits 5,6 et 7 de LCDACTL √† 1). $f_{LCD}$ est donc √©gal √† 32768 / 512 = 75,71 Hz. Donc $f_{frame} = f_{LCD} / (2 * 4) = 9,46Hz$, car mux = 4.

\paragraph{Question 7 ---}  Il nous faut changer les 3 derniers bits de LCDACTL. C'est √† √ßa que sert la ligne 21 "(n<<5)", c'est √† dire √©crire n √† partir du 5√®me bit dans LCDACTL. Au lien de diviser ACLK par 512, on choisit de diviser par 128, ce qui donne une valeur pour $f_{frame}$ de 32 Hz. L'√©cran ne scintille plus.

\paragraph{Question 8 ---}  A la ligne LCDMEM[j] = 0xFF, on change 0xFF par 0 pour √©teindre tous les segments.

\paragraph{Question 9 ---}  Le bo√Ætier de l'√©cran poss√®de 26 broches. LCD.pdf[3] nous montre qu'il y a 4 broches communes et 22 segments pins.

\paragraph{Question 10 ---}  22 * 4 = 88, il y a donc en tout 88 segments sur l'√©cran.

\paragraph{Question 11 ---}  Selon LCD.pdf[3], Dollar correspond √† COM0 (P18) et √† P26.

\paragraph{Question 12 ---}  Selon CPU.pdf[19], la pin 26 de l'√©cran est reli√©e √† la pin 37 du MSP430. COM0 est reli√©e √† la pin 52 du MSP430.

\paragraph{Question 13 ---}  Ins√©rer code...

\paragraph{Question 14 ---}  Ins√©rer code...

\paragraph{Question 15 ---}
\begin{verbatim}
// D'apr√®s Compiler.pdf[119], on met les 4 premiers param√®tres de la fonction dans R12:R15, et le reste dans la pile
// Cela est possible car chaque param√®tre est cod√© sur 16 bits, alors il y a un registre par param√®tre. Si les param√®tres √©taient plus larges, il faudrait deux registres par param√®tre, et donc plus de param√®tres dans la pile.
0031E6    1230 0007          push.w  #0x7 // on ajoute le param√®tre dans la pile
0031EA    1230 0006          push.w  #0x6
0031EE    1230 0005          push.w  #0x5
0031F2    422F               mov.w   #0x4,R15 // on ajoute le param√®tre dans un registre
0031F4    403E 0003          mov.w   #0x3,R14
0031F8    432D               mov.w   #0x2,R13
0031FA    431C               mov.w   #0x1,R12
0031FC    12B0 3182          call    #lcd_display_seven_digits // on appelle la sub-routine
\end{verbatim}

\paragraph{Question 17 ---}

\paragraph{Question 18 ---}  Selon Compiler.pdf[196], n est un entier non sign√©, cod√© sur 16 bits.

\paragraph{Question 19 ---}  On n'utilise ici que des variables cod√©es sur 16 bits. Le r√©sultat attendu de la multiplication de 30 000 par 40 000 est 1 200 000 000 or, la valeur maximum codable sur 16 bits est 65 535, il y a donc un d√©passement de capacit√©.

\paragraph{Question 20 ---}  Le r√©sultat de cette multiplication est codable sur 32 bits (valeur maximum : 4 294 967 295), on peut donc utiliser un \verb|unsigned long| (toujours selon Compiler.pdf[196])

\paragraph{Question 21 ---}  En remplacant au moins l'un des op√©randes en \verb|unsigned long| pour le coder sur 32 bits, la valeur calcul√©e est correcte. Il est int√©ressant de voir comment le compilateur g√®re ces grands nombres en les stockant dans deux registres 16 bits, et en effectuant de ce fait beaucoup plus d'op√©rations (copies, effacements, etc.)

\paragraph{Question 22 ---}  On choisit d'utiliser le type \verb|uint16_t| pour n afin d'avoir des valeurs assez grandes, mais on peut noter que le choix du type permet √©galement de choisir la valeur maximale du tirage au sort : 65535 pour \verb|uint16_t| et 255 pour \verb|uint8_t|.

\paragraph{Question 23 ---}  Lorsqu'on veut faire une multiplication par un petit nombre, le compilateur s'arrange pour simplifier la multiplication, c'est √† dire √©viter de faire plusieurs add √† la suite. On le voit dans ce code lors d'une multiplication par 3 :

\begin{verbatim}
alea:
 003246    421F 1100          mov.w   &n,R15 # R√©cup√©ration de la variable en zone statique
 00324A    4F0E               mov.w   R15,R14
 00324C    5F0F               rla.w   R15 # Rotation √† gauche : multiplication par deux
 00324E    5E0F               add.w   R14,R15 # on ajoute encore n √† lui-m√™me => multiplication par 3
 003250    503F 0005          add.w   #0x5,R15 # on ajoute encore 5 √† n
 003254    4F82 1100          mov.w   R15,&n # et on stocke la nouvelle valeur de n en zone statique
\end{verbatim}

D'apr√®s MSP430.pdf[351], on utilise ici un multiplieur mat√©riel 32 bits. Ce multiplieur poss√®de deux registres pour les op√©randes et un registre pour les r√©sultats. En pratique, il y a plusieurs registres suivant le param√©trage de la multiplication, mais ici on fait une multiplication simple.

\begin{verbatim}
alea:
 00320A    1202               push.w  SR
 00320C    C232               dint
 00320E    4303               nop
 003210    4292 1100 0130     mov.w   &n,&0x130 # on copie le premier op√©rande (n) dans un registre du multiplieur
 003216    40B2 01F4 0138     mov.w   #0x1F4,&0x138 # on copie le second op√©rande (500)
 00321C    421F 013A          mov.w   &0x13A,R15 # on r√©cup√®re le r√©sultat de la multiplication depuis un registre du multiplieur.
 003220    4132               pop.w   SR
 003222    503F 0190          add.w   #0x190,R15
 003226    4F82 1100          mov.w   R15,&n
\end{verbatim}

\paragraph{Question 24 ---}Le premier registre opÈrande de notre multiplieur OP1 est en vrai constituÈ de 12 registres et le second registre opÈrande de 3 registres. Dans le code assembleur de la question prÈcÈdente l'adresse 0x130 dans laquelle on place le premier opÈrande correspond au registre nommÈ MPY (pour les multiplication nons signÈ de nombre de 0 ‡ 16 bits);l'adresse 0x138, elle correspond au registre nommÈ OP2. L'adresse 0x13A d'o˘ on va rÈcupÈrer le rÈsultat de la multiplication correspond ‡ l'adresse du registre nommÈ RESLO.

\paragraph{Question 25 ---}bug, impossibilitÈ de faire pas ‡ pas. Entre dans la fonction alea() puis passe directement au return.

\paragraph{Question 26 ---}

option direct access, library calls, "pas du tout" : 
\begin{verbatim}
alea:
 00311E    421F 1100          mov.w   &n,R15
 003122    065F               rlam.w  #2,R15
 003124    4F0E               mov.w   R15,R14
 003126    065F               rlam.w  #2,R15
 003128    5F0E               add.w   R15,R14
 00312A    5F0F               rla.w   R15
 00312C    5F0E               add.w   R15,R14
 00312E    5F0F               rla.w   R15
 003130    5F0E               add.w   R15,R14
 003132    5F0F               rla.w   R15
 003134    5F0E               add.w   R15,R14
 003136    5F0F               rla.w   R15
 003138    5E0F               add.w   R14,R15
 00313A    503F 0190          add.w   #0x190,R15
 00313E    4F82 1100          mov.w   R15,&n
\end{verbatim}
Aucune distinction de cas

\paragraph{Question 27 ---}

- option direct access :
\begin{verbatim}
mul:
 00314A    1202               push.w  SR
 00314C    C232               dint
 00314E    4303               nop
 003150    4C82 0130          mov.w   R12,&MPY
 003154    4D82 0138          mov.w   R13,&OP2
 003158    421C 013A          mov.w   &RESLO,R12
 00315C    4132               pop.w   SR
 00315E    0110               reta
\end{verbatim}
 execution en 19 cycles

 -option library calls :
\begin{verbatim}
mul:
 003190    4D0E               mov.w   R13,R14
 003192    0080 3130          bra     #0x3130
\end{verbatim} 
26 cycles

-option "pas du tout" :
\begin{verbatim}
mul:
 0031A4    4D0E               mov.w   R13,R14
 0031A6    0080 3110          bra     #0x3110
\end{verbatim}
63 cycles

\paragraph{Question 28 ---} En vue des rÈsultats, la meilleur solution de compilation en terme de temps d'execution est celle de l'acces direct au multiplieur.

\paragraph{Question 29 ---} mul retourne reta
\end{document}
